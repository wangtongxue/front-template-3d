/**
 * Cesium - https://github.com/AnalyticalGraphicsInc/cesium
 *
 * Copyright 2011-2017 Cesium Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Columbus View (Pat. Pend.)
 *
 * Portions licensed separately.
 * See https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md for full licensing details.
 */
define(["exports","./when-4ca4e419","./defineProperties-163ddb68","./Cartesian3-32451e63","./Matrix4-33464f2b","./Cartesian2-f49a1383","./ComponentDatatype-329b9462","./AttributeCompression-7809eba4"],(function(t,e,r,i,a,n,o,s){"use strict";var m=e.freezeObject({NONE:0,BITS12:1}),u=new i.Cartesian3,c=new i.Cartesian3,d=new n.Cartesian2,h=new a.Matrix4,p=new a.Matrix4,x=Math.pow(2,12);function f(t,r,n,o,s,d){var f,l,C,y;if(e.defined(t)&&e.defined(r)&&e.defined(n)&&e.defined(o)){var M=t.minimum,b=t.maximum,T=i.Cartesian3.subtract(b,M,c),N=n-r;f=Math.max(i.Cartesian3.maximumComponent(T),N)<x-1?m.BITS12:m.NONE,l=t.center,C=a.Matrix4.inverseTransformation(o,new a.Matrix4);var g=i.Cartesian3.negate(M,u);a.Matrix4.multiply(a.Matrix4.fromTranslation(g,h),C,C);var v=u;v.x=1/T.x,v.y=1/T.y,v.z=1/T.z,a.Matrix4.multiply(a.Matrix4.fromScale(v,h),C,C),y=a.Matrix4.clone(o),a.Matrix4.setTranslation(y,i.Cartesian3.ZERO,y),o=a.Matrix4.clone(o,new a.Matrix4);var B=a.Matrix4.fromTranslation(M,h),E=a.Matrix4.fromScale(T,p),S=a.Matrix4.multiply(B,E,h);a.Matrix4.multiply(o,S,o),a.Matrix4.multiply(y,S,y)}this.quantization=f,this.minimumHeight=r,this.maximumHeight=n,this.center=l,this.toScaledENU=C,this.fromScaledENU=o,this.matrix=y,this.hasVertexNormals=s,this.hasWebMercatorT=e.defaultValue(d,!1)}f.prototype.encode=function(t,e,o,c,h,p,x){var f=c.x,l=c.y;if(this.quantization===m.BITS12){(o=a.Matrix4.multiplyByPoint(this.toScaledENU,o,u)).x=r.CesiumMath.clamp(o.x,0,1),o.y=r.CesiumMath.clamp(o.y,0,1),o.z=r.CesiumMath.clamp(o.z,0,1);var C=this.maximumHeight-this.minimumHeight,y=r.CesiumMath.clamp((h-this.minimumHeight)/C,0,1);n.Cartesian2.fromElements(o.x,o.y,d);var M=s.AttributeCompression.compressTextureCoordinates(d);n.Cartesian2.fromElements(o.z,y,d);var b=s.AttributeCompression.compressTextureCoordinates(d);n.Cartesian2.fromElements(f,l,d);var T=s.AttributeCompression.compressTextureCoordinates(d);if(t[e++]=M,t[e++]=b,t[e++]=T,this.hasWebMercatorT){n.Cartesian2.fromElements(x,0,d);var N=s.AttributeCompression.compressTextureCoordinates(d);t[e++]=N}}else i.Cartesian3.subtract(o,this.center,u),t[e++]=u.x,t[e++]=u.y,t[e++]=u.z,t[e++]=h,t[e++]=f,t[e++]=l,this.hasWebMercatorT&&(t[e++]=x);return this.hasVertexNormals&&(t[e++]=s.AttributeCompression.octPackFloat(p)),e},f.prototype.decodePosition=function(t,r,n){if(e.defined(n)||(n=new i.Cartesian3),r*=this.getStride(),this.quantization===m.BITS12){var o=s.AttributeCompression.decompressTextureCoordinates(t[r],d);n.x=o.x,n.y=o.y;var u=s.AttributeCompression.decompressTextureCoordinates(t[r+1],d);return n.z=u.x,a.Matrix4.multiplyByPoint(this.fromScaledENU,n,n)}return n.x=t[r],n.y=t[r+1],n.z=t[r+2],i.Cartesian3.add(n,this.center,n)},f.prototype.decodeTextureCoordinates=function(t,r,i){return e.defined(i)||(i=new n.Cartesian2),r*=this.getStride(),this.quantization===m.BITS12?s.AttributeCompression.decompressTextureCoordinates(t[r+2],i):n.Cartesian2.fromElements(t[r+4],t[r+5],i)},f.prototype.decodeHeight=function(t,e){return e*=this.getStride(),this.quantization===m.BITS12?s.AttributeCompression.decompressTextureCoordinates(t[e+1],d).y*(this.maximumHeight-this.minimumHeight)+this.minimumHeight:t[e+3]},f.prototype.getOctEncodedNormal=function(t,e,r){var i=t[e=(e+1)*this.getStride()-1]/256,a=Math.floor(i),o=256*(i-a);return n.Cartesian2.fromElements(a,o,r)},f.prototype.getStride=function(){var t;switch(this.quantization){case m.BITS12:t=3;break;default:t=6}return this.hasWebMercatorT&&++t,this.hasVertexNormals&&++t,t};var l={position3DAndHeight:0,textureCoordAndEncodedNormals:1},C={compressed0:0,compressed1:1};f.prototype.getAttributes=function(t){var e,r=o.ComponentDatatype.FLOAT,i=o.ComponentDatatype.getSizeInBytes(r);if(this.quantization===m.NONE){var a=2;return this.hasWebMercatorT&&++a,this.hasVertexNormals&&++a,[{index:l.position3DAndHeight,vertexBuffer:t,componentDatatype:r,componentsPerAttribute:4,offsetInBytes:0,strideInBytes:e=(4+a)*i},{index:l.textureCoordAndEncodedNormals,vertexBuffer:t,componentDatatype:r,componentsPerAttribute:a,offsetInBytes:4*i,strideInBytes:e}]}var n=3,s=0;return(this.hasWebMercatorT||this.hasVertexNormals)&&++n,this.hasWebMercatorT&&this.hasVertexNormals?(++s,[{index:C.compressed0,vertexBuffer:t,componentDatatype:r,componentsPerAttribute:n,offsetInBytes:0,strideInBytes:e=(n+s)*i},{index:C.compressed1,vertexBuffer:t,componentDatatype:r,componentsPerAttribute:s,offsetInBytes:n*i,strideInBytes:e}]):[{index:C.compressed0,vertexBuffer:t,componentDatatype:r,componentsPerAttribute:n}]},f.prototype.getAttributeLocations=function(){return this.quantization===m.NONE?l:C},f.clone=function(t,r){return e.defined(r)||(r=new f),r.quantization=t.quantization,r.minimumHeight=t.minimumHeight,r.maximumHeight=t.maximumHeight,r.center=i.Cartesian3.clone(t.center),r.toScaledENU=a.Matrix4.clone(t.toScaledENU),r.fromScaledENU=a.Matrix4.clone(t.fromScaledENU),r.matrix=a.Matrix4.clone(t.matrix),r.hasVertexNormals=t.hasVertexNormals,r.hasWebMercatorT=t.hasWebMercatorT,r},t.TerrainEncoding=f}));
